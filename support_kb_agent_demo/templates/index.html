<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support KB Agent - Intelligent Document Q&A</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-wrapper">
        <!-- Header Navigation -->
        <header>
            <div class="header-content">
                <a href="/" class="logo">
                    Support KB Agent
                </a>
<nav>
    <a href="/" class="active">Query</a>
</nav>
            </div>
        </header>

        <!-- Main Content -->
<main style="display: flex; align-items: center; justify-content: center; min-height: 80vh;">
    <div class="container container-md">
                <!-- Hero Section -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">Intelligent Document Q&A</h1>
                    <p style="color: var(--text-secondary); font-size: 1.1rem;">
                        Ask questions about your documents and get instant, accurate answers powered by AI
                    </p>
                </div>

                <!-- Error Display -->
                {% if error %}
                <div class="error-alert">
                    {{ error }}
                </div>
                {% endif %}

                <!-- Query Form -->
<form method="post" id="queryForm" enctype="multipart/form-data">
    {% if document_loaded %}
        <div class="form-group" style="margin-bottom: 1rem; background: var(--bg-tertiary); padding: 1rem; border-radius: 6px;">
            <strong>Document loaded:</strong> {{ document_name }}
            <button type="button" class="btn btn-danger" id="remove-document-btn" style="margin-left: 1rem;">Remove Document</button>
        </div>
    {% else %}
        <div class="form-group">
            <label for="input_type">Document Type</label>
            <select name="input_type" id="input_type" required>
                <option value="pdf">PDF Document</option>
                <option value="md">Markdown File</option>
                <option value="web">Web Page</option>
            </select>
        </div>

        <div class="form-group" id="file-upload-group" style="display: none;">
            <label for="input_file" id="file-label">Upload File</label>
            <input
                type="file"
                name="input_file"
                id="input_file"
                accept=""
            >
            <small style="color: var(--text-secondary); margin-top: 0.25rem; display: block;" id="file-help">
                Upload a file from your computer
            </small>
        </div>

        <div class="form-group" id="path-url-group">
            <label for="input_path">File Path or URL</label>
            <input
                type="text"
                name="input_path"
                id="input_path"
                placeholder="e.g., ../data/sample.pdf or https://example.com"
                required
            >
            <small style="color: var(--text-secondary); margin-top: 0.25rem; display: block;">
                Provide the path to your document or a web URL
            </small>
        </div>
    {% endif %}

                    <div class="form-group">
                        <label for="question">Your Question</label>
                        <textarea
                            name="question"
                            id="question"
                            placeholder="What would you like to know about this document? Be specific for better results..."
                            required
                        ></textarea>
                        <small style="color: var(--text-secondary); margin-top: 0.25rem; display: block;">
                            Tip: Ask specific questions for more accurate answers
                        </small>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">
                            Ask Agent
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            Clear
                        </button>
                    </div>
                </form>

                <!-- Answer Display -->
                {% if answer %}
                <div class="answer-section" id="answer-section">
                    <h3>Agent Response</h3>
                    <div class="answer-text" id="answer-text">
                        {{ answer }}
                    </div>
                    <button type="button" class="btn btn-secondary" id="refresh-answer-btn" style="margin-top: 1rem;">
                        Refresh
                    </button>

                    <!-- Sources Display -->
                    {% if sources and sources|length > 0 %}
                    <div class="sources-section">
                        <h4>Retrieved Sources ({{ sources|length }})</h4>
                        {% for source in sources %}
                        <div class="source-card">
                            <div class="source-title">{{ source.source }}</div>
                            <div class="source-meta">
                                {% if source.page != 'N/A' %}
                                    Page: {{ source.page }}
                                {% else %}
                                    Source document
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Metadata Display -->
                    {% if metadata %}
                    <div class="metadata-section">
                        <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Performance Metrics</h4>
                        {% if metadata.get('ingest_time') %}
                        <div class="metadata-item">
                            <span>Document Ingestion</span>
                            <strong>{{ "%.2f"|format(metadata.ingest_time) }}s</strong>
                        </div>
                        {% endif %}
                        {% if metadata.get('chunk_time') %}
                        <div class="metadata-item">
                            <span>Chunking</span>
                            <strong>{{ "%.2f"|format(metadata.chunk_time) }}s</strong>
                        </div>
                        {% endif %}
                        {% if metadata.get('embedding_time') %}
                        <div class="metadata-item">
                            <span>Embedding</span>
                            <strong>{{ "%.2f"|format(metadata.embedding_time) }}s</strong>
                        </div>
                        {% endif %}
                        {% if metadata.get('retrieval_time') %}
                        <div class="metadata-item">
                            <span>Retrieval and Generation</span>
                            <strong>{{ "%.2f"|format(metadata.retrieval_time) }}s</strong>
                        </div>
                        {% endif %}
                        {% if metadata.get('doc_count') %}
                        <div class="metadata-item">
                            <span>Documents Processed</span>
                            <strong>{{ metadata.doc_count }}</strong>
                        </div>
                        {% endif %}
                        {% if metadata.get('chunk_count') %}
                        <div class="metadata-item">
                            <span>Chunks Created</span>
                            <strong>{{ metadata.chunk_count }}</strong>
                        </div>
                        {% endif %}
                        {% if metadata.get('sources_count') %}
                        <div class="metadata-item">
                            <span>Sources Retrieved</span>
                            <strong>{{ metadata.sources_count }}</strong>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Example Queries -->
                {% if not answer %}
                <div style="margin-top: 3rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Example Queries</h3>
                    <ul style="list-style: none; color: var(--text-secondary);">
                        <li>"Summarize the main findings in this document"</li>
                        <li>"What are the key risks mentioned?"</li>
                        <li>"List all important dates and deadlines"</li>
                        <li>"What are the recommendations?"</li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div style="text-align:center;">
            <span class="loading" style="display:inline-block; margin-bottom:1rem;"></span>
            <div style="font-size:1.2rem; color:var(--text-primary);">Processing your request...<br>Please wait.</div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Refresh button logic: clears only the answer section
        const refreshBtn = document.getElementById('refresh-answer-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                const answerSection = document.getElementById('answer-section');
                if (answerSection) {
                    answerSection.style.display = 'none';
                }
            });
        }
        // Remove Document button logic
        const removeDocBtn = document.getElementById('remove-document-btn');
        if (removeDocBtn) {
            removeDocBtn.addEventListener('click', function() {
                fetch('/remove_document', { method: 'POST' })
                    .then(() => window.location.reload());
            });
        }
        // Form handling with loading overlay
        document.getElementById('queryForm').addEventListener('submit', function(e) {
            document.getElementById('loading-overlay').style.display = 'flex';
        });

        // Dynamic file input logic (only if document is not loaded)
        {% if not document_loaded %}
        const inputType = document.getElementById('input_type');
        const fileGroup = document.getElementById('file-upload-group');
        const fileInput = document.getElementById('input_file');
        const fileLabel = document.getElementById('file-label');
        const fileHelp = document.getElementById('file-help');
        const pathUrlGroup = document.getElementById('path-url-group');
        const pathInput = document.getElementById('input_path');

        function updateInputFields() {
            const type = inputType.value;
            if (type === 'pdf') {
                fileGroup.style.display = '';
                fileInput.accept = '.pdf,application/pdf';
                fileLabel.textContent = 'Upload PDF File';
                fileHelp.textContent = 'Upload a PDF file from your computer';
                pathUrlGroup.style.display = 'none';
                pathInput.required = false;
                fileInput.required = true;
            } else if (type === 'md') {
                fileGroup.style.display = '';
                fileInput.accept = '.md,text/markdown';
                fileLabel.textContent = 'Upload Markdown File';
                fileHelp.textContent = 'Upload a Markdown (.md) file from your computer';
                pathUrlGroup.style.display = 'none';
                pathInput.required = false;
                fileInput.required = true;
            } else if (type === 'web') {
                fileGroup.style.display = '';
                fileInput.accept = '.html,.htm,text/html';
                fileLabel.textContent = 'Upload Webpage File';
                fileHelp.textContent = 'Upload an HTML file from your computer';
                pathUrlGroup.style.display = 'none';
                pathInput.required = false;
                fileInput.required = true;
            } else {
                fileGroup.style.display = 'none';
                pathUrlGroup.style.display = '';
                pathInput.required = true;
                fileInput.required = false;
            }
        }

        inputType.addEventListener('change', updateInputFields);
        updateInputFields();
        {% endif %}
    });
    </script>
</body>
</html>